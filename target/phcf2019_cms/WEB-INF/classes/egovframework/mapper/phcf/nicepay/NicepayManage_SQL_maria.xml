<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="NicepayDAO">

<update id="updateDelSendYn" parameterType="java.util.HashMap">
	update tb_support_cms set del_send_yn = 'Y', del_send_file = #{userMemFileName}
	where cms_id in
	<foreach collection="updateDelSendList" item="item" open="(" separator="," close=")">
		#{item}
	</foreach>
</update>

<select id="selectCreateUserList" resultType="java.util.HashMap">
	SELECT 
		cms_id						/* 테이블 SEQ */
		, user_id						/* 회원등록자 ID */
		, agree_send_yn			/* 동의서 전송여부 */
		, user_send_yn				/* 회원신청 전송여부 */
		, del_target_yn				/* 회원신청 삭제대상 여부 */
		, del_send_yn				/* 회원신청 삭제 완료여부 */
		, acc_tp						/* 카드 또는 CMS 이냐.. */
		, user_name				/* 회원등록자 이름 */
		, user_phone				/* 회원등록자 폰번호 */
		, user_email					/* 회원등록자 이메일 */
		, bank_code				/* CMS회원 은행코드 */
		, bank_acc_num			/* CMS회원 입금계좌번호 */
		, bank_acc_user_nm		/* CMS회원 예금주 명 */
		, bank_acc_user_num	/* CMS회원 예금주 주민번호 */
		, card_num					/* 카드회원 카드번호 */
		, card_year_month		/* 카드회원 유효년월 */
		, sc_price					/* 입금액 */
		, sc_req_dd					/* 출금요청일 */
		, sc_cnt						/* 회차 */
		, use_yn
	FROM 
		tb_support_cms
	WHERE 1=1
		AND user_id IS NOT NULL		/* user_id는 필수 값이어여야 한다. */
		AND use_yn = 'Y'					/* 사용여부가 'Y'인 것 만 */
		AND ((acc_tp = 'S' and agree_send_yn = 'Y') OR acc_tp = 'D')			/* 출금이체동의서 전송이 완료된 사람 이거나 카드정기인 사람 조회 한다. */
		AND (user_send_yn = 'N' OR (del_target_yn = 'Y' AND del_send_yn = 'N'))			/* 회원등록이 안된 사람 및 삭제대상을 조회해 옴 된다.. */
</select>

<update id="updatePaySendYn" parameterType="java.util.HashMap">
	/* 출금정보 update 처리 */
	update tb_support_cms set pay_send_yn = 'Y', agree_num = #agreeNum#
	where
		<if test="userId != null">
			user_id = #{userId}
		</if> 
</update>

<select id="selectCreatePayList" parameterType="java.lang.String" resultType="java.util.HashMap">
	SELECT 
		cms_id						/* 테이블 SEQ */
		, user_id						/* 회원등록자 ID */
		, acc_tp						/* 카드 또는 CMS 이냐.. */
		, user_name				/* 회원등록자 이름 */
		, user_phone				/* 회원등록자 폰번호 */
		, user_email					/* 회원등록자 이메일 */
		, bank_code				/* CMS회원 은행코드 */
		, bank_acc_num			/* CMS회원 입금계좌번호 */
		, bank_acc_user_nm		/* CMS회원 예금주 명 */
		, bank_acc_user_num	/* CMS회원 예금주 주민번호 */
		, card_num					/* 카드회원 카드번호 */
		, card_year_month		/* 카드회원 유효년월 */
		, sc_price					/* 입금액 */
		, sc_req_dd					/* 출금요청일 */
		, sc_cnt						/* 회차 */
	FROM 
		tb_support_cms
	WHERE 1=1
		AND user_id IS NOT NULL		/* user_id는 필수 값이어여야 한다. */
		AND use_yn = 'Y'					/* 사용여부가 'Y'인 것 만 */
		AND user_send_yn = 'Y'			/* 회원등록이 된 사람만 가져 와야 된다. */
		AND (bank_acc_num IS NOT NULL OR card_num IS NOT NULL) /* 계좌번호나 카드번호가 없으면 안됨 */
		AND sc_req_dd = #{intTodayPlus1Day}
</select>

<update id="updateAgreeSendYn" parameterType="java.util.HashMap">
	/* CMS이체 동의서 전송 결과를 업데이트 한다. */
	update tb_support_cms set agree_send_yn = 'Y'
	where user_id in
		<foreach collection="userIdArr" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
</update>

<select id="selectAgreeCheckList" resultType="java.util.HashMap">
	/* CMS이체 동의서 점검 대상 리스트를 가져온다. */
	SELECT 
		cms_id				/* 컬럼ID */
		, user_id				/* 사용자ID */
		, agree_send_yn 	/* 동의서전송 여부 */
	FROM 
		tb_support_cms
	WHERE 
		use_yn = 'Y'
		AND agree_send_yn = 'N'
</select>

</mapper>