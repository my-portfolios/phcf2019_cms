<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mberManageDAO">

    <resultMap id="stplatMap" type="egovframework.com.uss.umt.service.StplatVO">
        <result property="useStplatId" column="USE_STPLAT_ID"/>
        <result property="useStplatCn" column="USE_STPLAT_CN"/>
        <result property="infoProvdAgeCn" column="INFO_PROVD_AGRE_CN"/>
    </resultMap>
    
 <select id="selectMberList" resultType="egovMap">
SELECT 
    uniqId, userTy, userId , userNm, emailAdres, areaNo, middleTelno, endTelno, moblphonNo, groupId, sttus, sbscrbDe, membershipType,membershipStartDt
FROM(
    SELECT 
        ESNTL_ID               uniqId,
        'USR01'               userTy,
        MBER_ID               userId,
        MBER_NM               userNm,
        MBER_EMAIL_ADRES      emailAdres,
        AREA_NO               areaNo,
        MIDDLE_TELNO          middleTelno,
        END_TELNO             endTelno,
        MBTLNUM           moblphonNo,
        GROUP_ID              groupId,
        MBER_STTUS            sttus,
        SBSCRB_DE             sbscrbDe,
        MEMBERSHIP_TYPE		 membershipType,
        MEMBERSHIP_START_DT	membershipStartDt
    FROM    COMTNGNRLMBER
    ) A
        WHERE 1=1
        <if test='sbscrbSttus != null and sbscrbSttus neq "0" and sbscrbSttus neq ""'>
            AND sttus LIKE  #{sbscrbSttus}
        </if>
        <if test="@egovframework.com.cmm.util.EgovMybaitsUtil@isNotEmpty(searchKeyword)">
        <if test="searchCondition == 0">AND
             userId LIKE #{searchKeyword}
        </if>
        <if test="searchCondition == 1">AND
             userNm LIKE '%' #{searchKeyword} '%'
        </if>
        </if>
        ORDER BY sbscrbDe DESC
        LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
    </select>
    
    
        <select id="selectMberListTotCnt" resultType="int">
            SELECT COUNT(1) totcnt
            FROM(
            SELECT 
                ESNTL_ID               uniqId,
                'USR01'               userTy,
                MBER_ID               userId,
                MBER_NM               userNm,
                MBER_EMAIL_ADRES      emailAdres,
                AREA_NO               areaNo,
                MIDDLE_TELNO          middleTelno,
                END_TELNO             endTelno,
                MBTLNUM           moblphonNo,
                GROUP_ID              groupId,
                MBER_STTUS            sttus,
                SBSCRB_DE             sbscrbDe
            FROM    COMTNGNRLMBER WHERE 1=1
            <if test='membershipType != null and !membershipType.equals("") and sbscrbDeBegin != null and !sbscrbDeBegin.equals("") and sbscrbDeEnd != null and !sbscrbDeEnd.equals("")'>AND
					MEMBERSHIP_TYPE LIKE #{membershipType}
					AND
					MEMBERSHIP_START_DT BETWEEN DATE(#{sbscrbDeBegin}) AND DATE(#{sbscrbDeEnd})
			</if>	
            <if test='(membershipType == null or membershipType.equals("")) and sbscrbDeBegin != null and !sbscrbDeBegin.equals("") and sbscrbDeEnd != null and !sbscrbDeEnd.equals("")'>AND
					SBSCRB_DE BETWEEN DATE(#{sbscrbDeBegin}) AND DATE(#{sbscrbDeEnd})
			</if>	
            ) A
        WHERE 1=1
            <if test='sbscrbSttus != null and sbscrbSttus neq "0" and sbscrbSttus neq ""'>
                AND sttus LIKE  #{sbscrbSttus}
            </if>
            <if test="@egovframework.com.cmm.util.EgovMybaitsUtil@isNotEmpty(searchKeyword)">
            <if test="searchCondition == 0">AND
                 userId LIKE #{searchKeyword}
            </if>
            <if test="searchCondition == 1">AND
                 userNm LIKE '%' #{searchKeyword} '%'
            </if>
            </if>
    </select>
    
    <insert id="insertMber_S">
        
            INSERT INTO COMTNGNRLMBER 
                (   
                    ESNTL_ID          ,
                    MBER_ID          ,
                    MBER_NM          ,
                    PASSWORD         ,
                    PASSWORD_HINT    ,
                    PASSWORD_CNSR    ,
                    IHIDNUM          ,
                    SEXDSTN_CODE     ,
                    ZIP              ,
                    ADRES            ,
                    AREA_NO          ,
                    MBER_STTUS       ,
                    DETAIL_ADRES     ,
                    END_TELNO        ,
                    MBTLNUM      ,
                    GROUP_ID         ,
                    MBER_FXNUM       ,
                    MBER_EMAIL_ADRES ,
                    MIDDLE_TELNO     ,
                    SBSCRB_DE,
                    MEMBERSHIP_TYPE,
        			MEMBERSHIP_START_DT        )
              VALUES(
                    #{uniqId},
                    #{mberId},
                    #{mberNm},
                    #{password},
                    #{passwordHint},
                    #{passwordCnsr},
                    #{ihidnum},
                    #{sexdstnCode},
                    #{zip},
                    #{adres},
                    #{areaNo},
                    #{mberSttus},
                    #{detailAdres},
                    #{endTelno},
                    #{moblphonNo},
                    #{groupId},
                    #{mberFxnum},
                    #{mberEmailAdres},
                    #{middleTelno},
                    sysdate(), 
                    #{membershipType},
                    #{membershipStartDt})              
        
    </insert>
    
    <delete id="deleteMber_S">
        
            DELETE FROM COMTNGNRLMBER 
            WHERE ESNTL_ID=#{delId}
        
    </delete>
    
    <select id="selectMber_S" resultType="egovframework.com.uss.umt.service.MberManageVO">
        
            SELECT
                ESNTL_ID          uniqId,
                'USR01'          userTy,
                MBER_ID          mberId,
                MBER_NM          mberNm,
                PASSWORD         password,
                PASSWORD_HINT    passwordHint,
                PASSWORD_CNSR    passwordCnsr,
                IHIDNUM          ihidnum,
                SEXDSTN_CODE     sexdstnCode,
                ZIP              zip,
                ADRES            adres,
                AREA_NO          areaNo,
                MBER_STTUS       mberSttus,
                DETAIL_ADRES     detailAdres,
                END_TELNO        endTelno,
                MBTLNUM      moblphonNo,
                GROUP_ID         groupId,
                MBER_FXNUM       mberFxnum,
                MBER_EMAIL_ADRES mberEmailAdres,
                MIDDLE_TELNO     middleTelno,
                SBSCRB_DE        sbscrbDe,
                LOCK_AT          lockAt,
                MEMBERSHIP_TYPE		 membershipType,
        		MEMBERSHIP_START_DT	membershipStartDt
            FROM COMTNGNRLMBER
            WHERE ESNTL_ID=#{uniqId}
        
    </select>
    
    <update id="updateMber_S">
        
            UPDATE COMTNGNRLMBER 
            SET MBER_ID          = #{mberId},
                MBER_NM          = #{mberNm},
                PASSWORD_HINT    = #{passwordHint},
                PASSWORD_CNSR    = #{passwordCnsr},
                IHIDNUM          = #{ihidnum},
                SEXDSTN_CODE     = #{sexdstnCode},
                ZIP              = #{zip},
                ADRES            = #{adres},
                AREA_NO          = #{areaNo},
                MBER_STTUS       = #{mberSttus},
                DETAIL_ADRES     = #{detailAdres},
                END_TELNO        = #{endTelno},
                MBTLNUM      = #{moblphonNo},
                GROUP_ID         = #{groupId},
                MBER_FXNUM       = #{mberFxnum},
                MBER_EMAIL_ADRES = #{mberEmailAdres},
                MIDDLE_TELNO     = #{middleTelno},
                MEMBERSHIP_TYPE = #{membershipType},
        		MEMBERSHIP_START_DT	= #{membershipStartDt}
            WHERE ESNTL_ID=#{uniqId}
        
    </update>
    
    <select id="selectStplat_S" resultMap="stplatMap">
        
            SELECT
                USE_STPLAT_ID           ,
                USE_STPLAT_CN           ,
                INFO_PROVD_AGRE_CN      
            FROM COMTNSTPLATINFO
            WHERE USE_STPLAT_ID=#{stplatId}
        
    </select>
    
    <update id="updatePassword_S">
        
            UPDATE COMTNGNRLMBER 
            SET 
                   PASSWORD   =  #{password}
            WHERE  ESNTL_ID  = #{uniqId}
        
    </update>
    
    <select id="selectPassword_S" resultType="egovframework.com.uss.umt.service.MberManageVO">
        
            SELECT
                    PASSWORD          password 
            FROM    COMTNGNRLMBER
            WHERE   ESNTL_ID=#{uniqId}
        
    </select>

    <update id="updateLockIncorrect">
            UPDATE COMTNGNRLMBER 
 			   SET  LOCK_AT = NULL 
			     ,  LOCK_CNT  = NULL 
			     ,  LOCK_LAST_PNTTM = NULL 
            WHERE  ESNTL_ID  = #{uniqId}
    </update>
    
    <select id="getDormantMber" resultType="java.util.HashMap">
        
            WITH LOGINLIST AS (
           	   SELECT DISTINCT CONECT_ID, CREAT_DT from COMTNLOGINLOG WHERE DATE_ADD(DATE_FORMAT(CREAT_DT, "%Y/%m/%d"), INTERVAL ${sPeriod} MONTH) <![CDATA[<]]> now()
			)
			SELECT 
				a.ESNTL_ID         uniqId,
                'USR01'            userTy,
                a.MBER_ID          mberId,
                a.MBER_NM          mberNm,
                a.PASSWORD         password,
                a.PASSWORD_HINT    passwordHint,
                a.PASSWORD_CNSR    passwordCnsr,
                a.IHIDNUM          ihidnum,
                a.SEXDSTN_CODE     sexdstnCode,
                a.ZIP              zip,
                a.ADRES            adres,
                a.AREA_NO          areaNo,
                a.MBER_STTUS       mberSttus,
                a.DETAIL_ADRES     detailAdres,
                a.END_TELNO        endTelno,
                a.MBTLNUM          moblphonNo,
                a.GROUP_ID         groupId,
                (SELECT GROUP_NM FROM COMTNAUTHORGROUPINFO WHERE GROUP_ID = a.GROUP_ID) groupNm,
                a.MBER_FXNUM       mberFxnum,
                a.MBER_EMAIL_ADRES mberEmailAdres,
                a.MIDDLE_TELNO     middleTelno,
                DATE_FORMAT(a.SBSCRB_DE, "%Y/%m/%d") sbscrbDe,
                a.LOCK_AT          lockAt,
                a.MEMBERSHIP_TYPE		 membershipType,
        		a.MEMBERSHIP_START_DT	membershipStartDt,
				DATE_FORMAT(b.CREAT_DT, "%Y/%m/%d") creatDt,
				a.user_comp_nm		userCompNm,
        		a.user_comp_number	userCompNumber,
        		a.send_mail_yn		sendMailYn
			FROM COMTNGNRLMBER a, LOGINLIST b
			WHERE a.ESNTL_ID = b.CONECT_ID
			AND a.MBER_STTUS = 'P'
			GROUP BY uniqId
	        ORDER BY sbscrbDe DESC
        
    </select>
    
    <select id="getMovedDormantMber" resultType="java.util.HashMap">
        	
        	WITH LOGINLIST AS (
           	   SELECT DISTINCT CONECT_ID, CREAT_DT from COMTNLOGINLOG WHERE DATE_ADD(DATE_FORMAT(CREAT_DT, "%Y/%m/%d"), INTERVAL ${sPeriod} MONTH) <![CDATA[<]]> now()
			)
            SELECT 
				a.ESNTL_ID         uniqId,
                a.MBER_ID          mberId,
                a.MBER_NM          mberNm,
                a.PASSWORD         password,
                a.PASSWORD_HINT    passwordHint,
                a.PASSWORD_CNSR    passwordCnsr,
                a.IHIDNUM          ihidnum,
                a.SEXDSTN_CODE     sexdstnCode,
                a.ZIP              zip,
                a.ADRES            adres,
                a.AREA_NO          areaNo,
                a.MBER_STTUS       mberSttus,
                a.DETAIL_ADRES     detailAdres,
                a.END_TELNO        endTelno,
                a.MBTLNUM          moblphonNo,
                a.GROUP_ID         groupId,
                (SELECT GROUP_NM FROM COMTNAUTHORGROUPINFO WHERE GROUP_ID = a.GROUP_ID) groupNm,
                a.MBER_FXNUM       mberFxnum,
                a.MBER_EMAIL_ADRES mberEmailAdres,
                a.MIDDLE_TELNO     middleTelno,
                DATE_FORMAT(a.SBSCRB_DE, "%Y/%m/%d") sbscrbDe,
                a.LOCK_AT          lockAt,
                a.MEMBERSHIP_TYPE		 membershipType,
        		a.MEMBERSHIP_START_DT	membershipStartDt,
        		DATE_FORMAT(b.CREAT_DT, "%Y/%m/%d") creatDt,
        		a.user_comp_nm		userCompNm,
        		a.user_comp_number	userCompNumber,
        		a.send_mail_yn		sendMailYn
			FROM SLEEPMEMBERLIST a, LOGINLIST b
			WHERE a.ESNTL_ID = b.CONECT_ID
			GROUP BY uniqId
	        ORDER BY sbscrbDe DESC
        
    </select>
    
    <select id="getDormantMberCnt" resultType="int">
        
            WITH LOGINLIST AS (
			   SELECT DISTINCT CONECT_ID from COMTNLOGINLOG WHERE DATE_ADD(DATE_FORMAT(creat_dt, "%Y/%m/%d"), INTERVAL ${sPeriod} MONTH) <![CDATA[<]]> now()
			)
			SELECT 
				COUNT(a.MBER_ID)
			FROM COMTNGNRLMBER a, LOGINLIST b
			WHERE a.ESNTL_ID = b.CONECT_ID
        
    </select>
    
    <select id="getMovedDormantMberCnt" resultType="int">
        	
        	WITH LOGINLIST AS (
			   SELECT DISTINCT CONECT_ID from COMTNLOGINLOG WHERE DATE_ADD(DATE_FORMAT(creat_dt, "%Y/%m/%d"), INTERVAL ${sPeriod} MONTH) <![CDATA[<]]> now()
			)
            SELECT 
				COUNT(a.MBER_ID)
			FROM SLEEPMEMBERLIST a, LOGINLIST b
			WHERE a.ESNTL_ID = b.CONECT_ID
			
        
    </select>
    
    <select id="getDormantMber12" resultType="egovframework.com.uss.umt.service.MberManageVO">
        
            WITH LOGINLIST AS (
				SELECT max.CONECT_ID, max.CREAT_DT 
					  FROM 
					  (
					  	SELECT MAX(CREAT_DT) AS CREAT_DT, CONECT_ID FROM COMTNLOGINLOG GROUP BY CONECT_ID
					  ) max
					  WHERE DATE_ADD(DATE_FORMAT(max.CREAT_DT, "%Y/%m/%d"), INTERVAL 1 YEAR) <![CDATA[<]]> now()
           	   )

				SELECT 
				a.ESNTL_ID         uniqId,
                'USR01'            userTy,
                a.MBER_ID          mberId,
                a.MBER_NM          mberNm,
                a.PASSWORD         password,
                a.PASSWORD_HINT    passwordHint,
                a.PASSWORD_CNSR    passwordCnsr,
                a.IHIDNUM          ihidnum,
                a.SEXDSTN_CODE     sexdstnCode,
                a.ZIP              zip,
                a.ADRES            adres,
                a.AREA_NO          areaNo,
                a.MBER_STTUS       mberSttus,
                a.DETAIL_ADRES     detailAdres,
                a.END_TELNO        endTelno,
                a.MBTLNUM          moblphonNo,
                a.GROUP_ID         groupId,
                a.MBER_FXNUM       mberFxnum,
                a.MBER_EMAIL_ADRES mberEmailAdres,
                a.MIDDLE_TELNO     middleTelno,
                DATE_FORMAT(a.SBSCRB_DE, "%Y/%m/%d") sbscrbDe,
                a.LOCK_AT          lockAt,
                a.MEMBERSHIP_TYPE		 membershipType,
        		a.MEMBERSHIP_START_DT	membershipStartDt,
        		DATE_FORMAT(b.CREAT_DT, "%Y/%m/%d") creatDt,
        		a.user_comp_nm		userCompNm,
        		a.user_comp_number	userCompNumber,
        		a.send_mail_yn		sendMailYn,
        		a.ci				ci,
        		a.di				di
			FROM COMTNGNRLMBER a, LOGINLIST b
			WHERE a.ESNTL_ID = b.CONECT_ID
			AND a.MBER_STTUS = 'P'
			GROUP BY uniqId
	        ORDER BY sbscrbDe DESC
        
    </select>
    
    <insert id="transferDormantMber" parameterType="egovframework.com.uss.umt.service.MberManageVO">
			
			INSERT INTO SLEEPMEMBERLIST
			(   
                    ESNTL_ID          ,
                    MBER_ID          ,
                    MBER_NM          ,
                    PASSWORD         ,
                    PASSWORD_HINT    ,
                    PASSWORD_CNSR    ,
                    IHIDNUM          ,
                    SEXDSTN_CODE     ,
                    ZIP              ,
                    ADRES            ,
                    AREA_NO          ,
                    MBER_STTUS       ,
                    DETAIL_ADRES     ,
                    END_TELNO        ,
                    MBTLNUM      ,
                    GROUP_ID         ,
                    MBER_FXNUM       ,
                    MBER_EMAIL_ADRES ,
                    MIDDLE_TELNO     ,
                    SBSCRB_DE,
                    MEMBERSHIP_TYPE,
        			MEMBERSHIP_START_DT,
        			USER_GRADE,
        			CI,
        			DI,
        			user_comp_nm,
        			user_comp_number,
        			send_mail_yn
        			)
              VALUES(
                    #{uniqId},
                    #{mberId},
                    #{mberNm},
                    #{password},
                    #{passwordHint},
                    #{passwordCnsr},
                    #{ihidnum},
                    #{sexdstnCode},
                    #{zip},
                    #{adres},
                    #{areaNo},
                    'H',
                    #{detailAdres},
                    #{endTelno},
                    #{moblphonNo},
                    #{groupId},
                    #{mberFxnum},
                    #{mberEmailAdres},
                    #{middleTelno},
                    sysdate(), 
                    #{membershipType},
                    #{membershipStartDt},
                    #{userGrade},
                    #{ci},
                    #{di},
                    #{userCompNm},
                    #{userCompNumber},
                    #{sendMailYn}
                    )       
			ON DUPLICATE KEY UPDATE
				MBER_ID          = #{mberId},
                MBER_NM          = #{mberNm},
                PASSWORD_HINT    = #{passwordHint},
                PASSWORD_CNSR    = #{passwordCnsr},
                IHIDNUM          = #{ihidnum},
                SEXDSTN_CODE     = #{sexdstnCode},
                ZIP              = #{zip},
                ADRES            = #{adres},
                AREA_NO          = #{areaNo},
                MBER_STTUS       = 'H',
                DETAIL_ADRES     = #{detailAdres},
                END_TELNO        = #{endTelno},
                MBTLNUM      = #{moblphonNo},
                GROUP_ID         = #{groupId},
                MBER_FXNUM       = #{mberFxnum},
                MBER_EMAIL_ADRES = #{mberEmailAdres},
                MIDDLE_TELNO     = #{middleTelno},
                MEMBERSHIP_TYPE = #{membershipType},
        		MEMBERSHIP_START_DT	= #{membershipStartDt},
        		USER_GRADE = #{userGrade},
        		CI = #{ci},
        		DI = #{di},
        		user_comp_nm = #{userCompNm},
        		user_comp_number = #{userCompNumber},
        		send_mail_yn = #{sendMailYn}
			
    </insert>
    
    <update id="updatetransferedDormantMberCode" parameterType="egovframework.com.uss.umt.service.MberManageVO">
			
			UPDATE COMTNGNRLMBER SET
			
			MBER_ID          = #{mberId},
            MBER_NM          = '',
            PASSWORD_HINT    = '',
            PASSWORD_CNSR    = '',
            IHIDNUM          = '',
            SEXDSTN_CODE     = '',
            ZIP              = '',
            ADRES            = '',
            AREA_NO          = '',
            MBER_STTUS       = 'H',
            DETAIL_ADRES     = '',
            END_TELNO        = '',
            MBTLNUM      	 = '',
            GROUP_ID         = #{groupId},
            MBER_FXNUM       = '',
            MBER_EMAIL_ADRES = '',
            MIDDLE_TELNO     = '',
            USER_GRADE		= '',
            CI				= '',
            DI				= '',
            user_comp_nm	= '',
            user_comp_number= '',
            send_mail_yn	= ''
    		
			WHERE ESNTL_ID = #{uniqId}
			
    </update>

</mapper>