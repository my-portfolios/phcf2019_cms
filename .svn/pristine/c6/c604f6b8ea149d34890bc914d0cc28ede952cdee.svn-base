<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SupportManageDAO">

<select id="getGradeCodeList" parameterType="java.lang.String" resultType="java.util.HashMap">
	/* 회원등급 코드 리스트를 유저구분별로 가져온다. */
	SELECT 
		code			/* 후원코드값 */
		, code_nm		/* 후원등급명 */
	FROM 
		COMTCCMMNDETAILCODE
	WHERE 
		CODE_ID = #{codeId}
</select>

<select id="getCmsSupportCnt" parameterType="java.util.HashMap" resultType="java.lang.Integer">
	/* CMS관리자용 후원정보 전체 건수 */
	SELECT
		count(1) as totCnt
	FROM
		tb_support_log
	WHERE 1=1
		<if test="search_user_tp != null">
			AND user_tp = #{search_user_tp}
		</if>
</select>

<select id="getCmsSupportList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	/* CMS관리자용 후원정보 조회 */
	SELECT
		sp_id						/* seq */
		, user_tp					/* 후원유저종류 */
		, T2.user_grade 			/* 회원등급 */
		, T1.user_id			/* 회원ID (로그인 사용자 OR 비로그인 사용자 */
		, ( CASE user_tp WHEN 'U' THEN T1.user_nm ELSE T1.user_comp_nm END ) AS user_nm		/* 휴원유저종류에 따라 유저명 또는 기업,단체명 입력 */
		, CONCAT( user_phone1, '-', user_phone2, '-', user_phone3 ) AS user_phone		/* 후원자 연락처 */
		, IF(user_email1 IS NULL OR user_email2 IS NULL OR LENGTH(user_email1) = 0 OR LENGTH(user_email2) = 0, NULL, CONCAT( user_email1, '@', user_email2 ) ) AS user_email	/* 후원자 이메일 */
		, ( CASE sp_mh_tp WHEN 'O' THEN '일시후원' ELSE '정기후원' END ) AS sp_mh_tp		/* 후원방식 */
		, ( CASE sc_price_tp WHEN 'C' THEN '카드' WHEN 'E' THEN '계좌이체' WHEN 'M' THEN '무통장' WHEN 'D' THEN '카드' WHEN 'S' THEN 'CMS계좌' ELSE '없음' END ) AS sc_price_tp
		, T1.sc_price		/* 후원금액 */
		, DATE_FORMAT(T1.create_dt, '%Y-%m-%d %H:%i:%S') as create_dt		/* 등록일 */
		, T1.browser			/* 결제모드 */
		, T1.ins_id				/* 등록자 */
		, T1.admin_msg		/* 관리자감사메시지 */
	FROM 
		tb_support_log T1		/* 후원 log 테이블 */
		LEFT JOIN
		( SELECT mber_id, user_grade FROM COMTNGNRLMBER ) T2	/* 회원정보 테이블 */
		ON T1.user_id = T2.mber_id
	WHERE 1=1
		<if test="search_user_tp != null">
			AND user_tp = #{search_user_tp}
		</if>
	ORDER BY sp_id desc
	LIMIT ${pageSize} OFFSET ${firstIndex}
</select>   

</mapper>